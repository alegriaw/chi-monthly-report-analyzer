# Amazon Q CLI 緩存時間分析：5分鐘 vs 10分鐘

## 緩存機制概述

Amazon Q CLI 狀態檢查使用緩存機制來避免頻繁的網路請求和 CLI 調用，提高應用程式性能和用戶體驗。

### 當前實現

```python
_amazon_q_cache = {
    'status': None,           # 布林值：CLI 是否可用
    'message': None,          # 字串：狀態描述
    'timestamp': 0,           # 時間戳：最後檢查時間
    'cache_duration': 300     # 緩存持續時間（秒）
}

# 緩存檢查邏輯
current_time = time.time()
if (current_time - _amazon_q_cache['timestamp'] < _amazon_q_cache['cache_duration']):
    return _amazon_q_cache['status'], _amazon_q_cache['message']
```

## 5分鐘緩存 vs 10分鐘緩存 詳細比較

### 1. **檢查頻率差異**

| 場景 | 5分鐘緩存 | 10分鐘緩存 | 差異 |
|------|-----------|------------|------|
| 1小時內檢查次數 | 最多 12 次 | 最多 6 次 | 減少 50% |
| 8小時工作日 | 最多 96 次 | 最多 48 次 | 減少 50% |
| 連續使用 30 分鐘 | 最多 6 次 | 最多 3 次 | 減少 50% |

### 2. **網路請求影響**

#### 5分鐘緩存
```python
# 每 5 分鐘執行一次
subprocess.run(['q', '--version'], timeout=5)           # ~0.03s
subprocess.run(['q', 'login'], timeout=3)               # ~1.5s
# 總計：每次檢查約 1.53 秒
```

#### 10分鐘緩存
```python
# 每 10 分鐘執行一次
# 同樣的檢查，但頻率減半
# 總計：每次檢查約 1.53 秒，但次數減少 50%
```

### 3. **用戶體驗影響**

#### 5分鐘緩存的用戶體驗
```
時間軸：
0:00  - 首次檢查 (1.5s 延遲)
0:01  - 使用緩存 (即時)
0:02  - 使用緩存 (即時)
0:03  - 使用緩存 (即時)
0:04  - 使用緩存 (即時)
0:05  - 重新檢查 (1.5s 延遲) ← 較頻繁
0:06  - 使用緩存 (即時)
...
```

#### 10分鐘緩存的用戶體驗
```
時間軸：
0:00  - 首次檢查 (1.5s 延遲)
0:01  - 使用緩存 (即時)
0:02  - 使用緩存 (即時)
...
0:09  - 使用緩存 (即時)
0:10  - 重新檢查 (1.5s 延遲) ← 較少頻繁
0:11  - 使用緩存 (即時)
...
```

### 4. **實際使用場景分析**

#### 場景 A：短期密集使用（15分鐘內）
```python
# 用戶在 15 分鐘內多次使用聊天功能

# 5分鐘緩存：
# 0分鐘：檢查 (1.5s)
# 5分鐘：檢查 (1.5s)  
# 10分鐘：檢查 (1.5s)
# 總延遲：4.5s

# 10分鐘緩存：
# 0分鐘：檢查 (1.5s)
# 10分鐘：檢查 (1.5s)
# 總延遲：3.0s
# 節省：1.5s (33% 改善)
```

#### 場景 B：長期間歇使用（2小時）
```python
# 用戶在 2 小時內間歇使用

# 5分鐘緩存：最多 24 次檢查 = 36s 總延遲
# 10分鐘緩存：最多 12 次檢查 = 18s 總延遲
# 節省：18s (50% 改善)
```

### 5. **狀態變化檢測**

#### Amazon Q CLI 狀態變化情況
1. **登入狀態變化**：用戶手動登出/登入
2. **網路連接問題**：暫時性網路中斷
3. **CLI 更新**：Amazon Q CLI 版本更新
4. **權限變化**：AWS 權限或配置變更

#### 檢測延遲比較

| 狀態變化 | 5分鐘緩存 | 10分鐘緩存 | 影響評估 |
|----------|-----------|------------|----------|
| 用戶登出 | 最多 5 分鐘延遲 | 最多 10 分鐘延遲 | 🟡 中等影響 |
| 網路恢復 | 最多 5 分鐘延遲 | 最多 10 分鐘延遲 | 🟡 中等影響 |
| CLI 更新 | 最多 5 分鐘延遲 | 最多 10 分鐘延遲 | 🟢 低影響 |
| 權限變更 | 最多 5 分鐘延遲 | 最多 10 分鐘延遲 | 🟡 中等影響 |

### 6. **程式碼實現差異**

#### 修改為 10 分鐘緩存
```python
# 只需要改變一個數值
_amazon_q_cache = {
    'status': None,
    'message': None,
    'timestamp': 0,
    'cache_duration': 600  # 改為 600 秒 (10 分鐘)
}
```

#### 動態緩存配置
```python
# 更靈活的配置方式
CACHE_DURATIONS = {
    'development': 60,    # 1 分鐘 (開發環境)
    'testing': 300,       # 5 分鐘 (測試環境)
    'production': 600     # 10 分鐘 (生產環境)
}

_amazon_q_cache = {
    'cache_duration': CACHE_DURATIONS.get('production', 300)
}
```

### 7. **性能指標比較**

#### CPU 和記憶體使用
```python
# 每次狀態檢查的資源消耗
def check_amazon_q_availability():
    # subprocess.run() 調用
    # 正則表達式處理
    # 字串操作
    # 約 0.1% CPU 使用率，持續 1.5 秒

# 5分鐘緩存：每小時 12 次 × 0.1% × 1.5s = 1.8% CPU·秒
# 10分鐘緩存：每小時 6 次 × 0.1% × 1.5s = 0.9% CPU·秒
# 節省：50% CPU 使用率
```

#### 網路流量
```python
# 每次檢查的網路活動
# q --version: 最小網路活動
# q login: 可能的認證檢查

# 5分鐘緩存：每天最多 288 次檢查
# 10分鐘緩存：每天最多 144 次檢查
# 節省：50% 網路請求
```

### 8. **錯誤處理影響**

#### 暫時性錯誤
```python
# 網路暫時中斷的情況

# 5分鐘緩存：
# 如果在第 3 分鐘網路中斷，用戶在第 5 分鐘就會發現
# 恢復時間：最多 2 分鐘

# 10分鐘緩存：
# 如果在第 3 分鐘網路中斷，用戶在第 10 分鐘才會發現
# 恢復時間：最多 7 分鐘
```

#### 手動刷新機制
```python
# 程式提供手動刷新按鈕
if st.button("🔄 Recheck Amazon Q"):
    clear_amazon_q_cache()  # 立即清除緩存
    st.rerun()

# 這個機制讓緩存時間的影響降到最低
```

## 建議和最佳實踐

### 1. **推薦配置**

```python
# 根據使用場景選擇
RECOMMENDED_CACHE_DURATIONS = {
    'interactive_development': 60,    # 1 分鐘
    'normal_usage': 300,              # 5 分鐘 (當前)
    'stable_environment': 600,        # 10 分鐘
    'batch_processing': 1800          # 30 分鐘
}
```

### 2. **動態調整策略**

```python
def get_optimal_cache_duration():
    """根據使用模式動態調整緩存時間"""
    
    # 檢查最近的使用頻率
    recent_checks = get_recent_check_frequency()
    
    if recent_checks > 10:  # 高頻使用
        return 300  # 5 分鐘
    elif recent_checks > 5:  # 中頻使用
        return 600  # 10 分鐘
    else:  # 低頻使用
        return 1800  # 30 分鐘
```

### 3. **混合策略**

```python
def smart_cache_check():
    """智能緩存檢查"""
    
    # 如果用戶剛剛進行了聊天操作，使用較短緩存
    if recent_chat_activity():
        cache_duration = 300  # 5 分鐘
    else:
        cache_duration = 600  # 10 分鐘
    
    return check_with_duration(cache_duration)
```

## 結論

### 5分鐘緩存的優勢
- ✅ **更快的狀態變化檢測**
- ✅ **更及時的錯誤恢復**
- ✅ **更適合開發和測試**

### 10分鐘緩存的優勢
- ✅ **減少 50% 的網路請求**
- ✅ **降低 50% 的 CPU 使用**
- ✅ **更適合穩定的生產環境**
- ✅ **減少對 Amazon Q 服務的負載**

### 實際影響評估

對於 CHI Analyzer 的使用場景：
- **短期影響**：幾乎無差別（有手動刷新按鈕）
- **長期影響**：10分鐘緩存更節省資源
- **用戶體驗**：差異很小（1.5秒 vs 即時響應）
- **系統穩定性**：10分鐘緩存更穩定

**建議**：可以安全地改為 10 分鐘緩存，因為：
1. 有手動刷新機制
2. Amazon Q 狀態變化不頻繁
3. 性能收益明顯
4. 對用戶體驗影響最小